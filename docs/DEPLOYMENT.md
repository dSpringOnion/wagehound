# 🚀 WageHound Deployment Guide

This guide covers deploying WageHound to various platforms with step-by-step instructions.

## 🎯 Deployment Overview

WageHound can be deployed to several platforms:
- **Railway** (Recommended) - Full-stack with built-in PostgreSQL
- **Vercel + Supabase** - Frontend on Vercel, backend on Supabase
- **Docker** - Containerized deployment
- **Self-hosted** - Custom server deployment

## 🚄 Railway Deployment (Recommended)

Railway provides the simplest deployment with integrated database and hosting.

### Prerequisites
- GitHub account
- Railway account (free tier available)
- WageHound repository on GitHub

### Step 1: Setup Repository
1. **Push code to GitHub**
   ```bash
   git add .
   git commit -m "Prepare for deployment"
   git push origin main
   ```

2. **Ensure all files are committed**
   - `package.json` with all dependencies
   - `prisma/schema.prisma`
   - `.env.local.example` (without secrets)

### Step 2: Railway Project Setup
1. **Login to Railway**
   - Visit [railway.app](https://railway.app)
   - Connect your GitHub account

2. **Create New Project**
   - Click "New Project"
   - Select "Deploy from GitHub repo"
   - Choose your WageHound repository

3. **Add Database**
   - Click "Add service"
   - Select "Database" → "PostgreSQL"
   - Railway automatically provisions database

### Step 3: Environment Variables
1. **Navigate to Variables tab**
2. **Add required variables:**
   ```env
   # Database (auto-generated by Railway)
   DATABASE_URL=${{Postgres.DATABASE_URL}}
   
   # Supabase (add your values)
   NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
   SUPABASE_URL=https://your-project.supabase.co
   SUPABASE_ANON_KEY=your-anon-key
   ```

### Step 4: Build Configuration
1. **Set Build Command**
   ```bash
   pnpm install && npx prisma generate && pnpm build
   ```

2. **Set Start Command**
   ```bash
   pnpm migrate && pnpm start
   ```

### Step 5: Deploy
1. **Trigger Deployment**
   - Push to main branch
   - Railway auto-deploys

2. **Monitor Deployment**
   - Check build logs in Railway dashboard
   - Verify successful deployment

3. **Access Application**
   - Railway provides public URL
   - Custom domains available in settings

### Railway Environment Example
```env
# Railway Auto-Generated
DATABASE_URL=postgresql://postgres:password@host:5432/railway
RAILWAY_ENVIRONMENT=production

# Your Supabase Config
NEXT_PUBLIC_SUPABASE_URL=https://abcdefgh.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_URL=https://abcdefgh.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

## ▲ Vercel + Supabase Deployment

Deploy frontend to Vercel with Supabase as backend service.

### Prerequisites
- Supabase account and project
- Vercel account
- GitHub repository

### Step 1: Supabase Setup
1. **Create Supabase Project**
   - Visit [supabase.com](https://supabase.com)
   - Create new project
   - Note URL and anon key

2. **Run Database Migrations**
   ```bash
   # Install Supabase CLI
   npm install -g supabase
   
   # Login and link project
   supabase login
   supabase link --project-ref your-project-ref
   
   # Run migrations
   supabase db push
   ```

3. **Configure Auth**
   - Enable Email auth in Supabase dashboard
   - Configure email templates
   - Set site URL to your Vercel domain

### Step 2: Vercel Deployment
1. **Connect Repository**
   - Visit [vercel.com](https://vercel.com)
   - Import GitHub repository
   - Select WageHound project

2. **Configure Build Settings**
   ```bash
   # Build Command
   pnpm build
   
   # Output Directory
   .next
   
   # Install Command
   pnpm install
   ```

3. **Environment Variables**
   ```env
   DATABASE_URL=postgresql://postgres:password@db.host.supabase.co:5432/postgres
   NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
   SUPABASE_URL=https://your-project.supabase.co
   SUPABASE_ANON_KEY=your-anon-key
   ```

4. **Deploy**
   - Click "Deploy"
   - Monitor build process
   - Access via provided URL

### Vercel Configuration File
Create `vercel.json`:
```json
{
  "buildCommand": "pnpm build",
  "outputDirectory": ".next",
  "installCommand": "pnpm install",
  "framework": "nextjs",
  "regions": ["iad1"],
  "env": {
    "DATABASE_URL": "@database-url",
    "NEXT_PUBLIC_SUPABASE_URL": "@supabase-url",
    "NEXT_PUBLIC_SUPABASE_ANON_KEY": "@supabase-anon-key"
  }
}
```

## 🐳 Docker Deployment

Containerize WageHound for consistent deployment across environments.

### Dockerfile
Create `Dockerfile`:
```dockerfile
# Use official Node.js runtime
FROM node:18-alpine AS base

# Install dependencies only when needed
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app

# Copy package files
COPY package.json pnpm-lock.yaml* ./
RUN npm install -g pnpm && pnpm install --frozen-lockfile

# Rebuild source code
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Generate Prisma client
RUN npm install -g pnpm
RUN npx prisma generate

# Build application
RUN pnpm build

# Production image
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# Copy built application
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000
ENV PORT 3000

CMD ["node", "server.js"]
```

### Docker Compose
Create `docker-compose.yml`:
```yaml
version: '3.8'

services:
  wagehound:
    build: .
    ports:
      - '3000:3000'
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/wagehound
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
    depends_on:
      - db

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=wagehound
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - '5432:5432'

volumes:
  postgres_data:
```

### Docker Deployment Commands
```bash
# Build and run
docker-compose up --build

# Run in production
docker-compose -f docker-compose.prod.yml up -d

# Run migrations
docker-compose exec wagehound npx prisma migrate deploy

# View logs
docker-compose logs -f wagehound
```

## 🔧 Environment Configuration

### Required Environment Variables
```env
# Database Connection
DATABASE_URL="postgresql://user:password@host:port/database"

# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL="https://project.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
SUPABASE_URL="https://project.supabase.co"
SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# Optional
NODE_ENV="production"
PORT="3000"
```

### Environment Validation
Add to your deployment script:
```bash
#!/bin/bash
# validate-env.sh

required_vars=(
  "DATABASE_URL"
  "NEXT_PUBLIC_SUPABASE_URL"
  "NEXT_PUBLIC_SUPABASE_ANON_KEY"
  "SUPABASE_URL"
  "SUPABASE_ANON_KEY"
)

for var in "${required_vars[@]}"; do
  if [ -z "${!var}" ]; then
    echo "Error: $var is not set"
    exit 1
  fi
done

echo "All required environment variables are set ✅"
```

## 🗄️ Database Setup

### Prisma Migrations
```bash
# Generate Prisma client
npx prisma generate

# Apply migrations in production
npx prisma migrate deploy

# Seed database (if needed)
npx prisma db seed
```

### Database Backup
```bash
# Backup database
pg_dump $DATABASE_URL > backup.sql

# Restore database
psql $DATABASE_URL < backup.sql
```

## 🔒 Security Configuration

### Production Security Checklist
- [ ] Environment variables secure
- [ ] Database credentials rotated
- [ ] HTTPS enabled
- [ ] Supabase RLS policies configured
- [ ] API rate limiting enabled
- [ ] Error logging configured
- [ ] Health checks implemented

### Supabase Security
```sql
-- Enable Row Level Security
ALTER TABLE shifts ENABLE ROW LEVEL SECURITY;
ALTER TABLE paychecks ENABLE ROW LEVEL SECURITY;

-- Create policies
CREATE POLICY "Users can only see their own shifts" ON shifts
  FOR ALL USING (auth.uid()::text = user_id);

CREATE POLICY "Users can only see their own paychecks" ON paychecks
  FOR ALL USING (auth.uid()::text = user_id);
```

## 📊 Monitoring and Health Checks

### Health Check Endpoint
Create `src/app/api/health/route.ts`:
```typescript
import { NextResponse } from 'next/server'
import { createClient } from '@/utils/supabase/server'

export async function GET() {
  try {
    const supabase = await createClient()
    
    // Test database connection
    const { data, error } = await supabase
      .from('users')
      .select('count')
      .limit(1)
    
    if (error) throw error

    return NextResponse.json({
      status: 'healthy',
      timestamp: new Date().toISOString(),
      database: 'connected'
    })
  } catch (error) {
    return NextResponse.json({
      status: 'unhealthy',
      timestamp: new Date().toISOString(),
      error: error.message
    }, { status: 500 })
  }
}
```

### Uptime Monitoring
```bash
# Simple uptime check
curl -f https://your-app.com/api/health || exit 1

# With notification
curl -f https://your-app.com/api/health || {
  echo "Health check failed!" | mail -s "WageHound Down" admin@company.com
  exit 1
}
```

## 🔄 CI/CD Pipeline

### GitHub Actions
Create `.github/workflows/deploy.yml`:
```yaml
name: Deploy to Railway

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install pnpm
      run: npm install -g pnpm
      
    - name: Install dependencies
      run: pnpm install
      
    - name: Run tests
      run: pnpm test
      
    - name: Build application
      run: pnpm build
      
    - name: Deploy to Railway
      uses: railway-app/railway-deploy@v1
      with:
        railway-token: ${{ secrets.RAILWAY_TOKEN }}
```

## 🚨 Troubleshooting

### Common Issues

#### Build Failures
```bash
# Clear cache and rebuild
rm -rf .next node_modules
pnpm install
pnpm build
```

#### Database Connection Issues
```bash
# Test connection
psql $DATABASE_URL -c "SELECT 1;"

# Check Prisma schema
npx prisma validate
npx prisma format
```

#### Environment Variable Issues
```bash
# Verify variables are set
printenv | grep SUPABASE
printenv | grep DATABASE

# Test Supabase connection
curl -H "apikey: $SUPABASE_ANON_KEY" "$SUPABASE_URL/rest/v1/"
```

### Deployment Checklist
- [ ] All environment variables configured
- [ ] Database migrations applied
- [ ] Supabase auth configured
- [ ] Health checks passing
- [ ] Error monitoring setup
- [ ] Backup strategy implemented
- [ ] SSL/HTTPS enabled
- [ ] Performance monitoring active

---

**WageHound is ready for production deployment! 🚀**